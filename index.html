<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Опитувальник "Адаптивність-200"</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --light-gray: #f0f2f5;
            --dark-gray: #6c757d;
            --white: #ffffff;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }
        
        /* --- ВИПРАВЛЕННЯ: Прибираємо горизонтальну прокрутку --- */
        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystem-Font, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* --- ВИПРАВЛЕННЯ: Робимо фон однаковим --- */
            background-color: var(--white);
            margin: 0;
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top));
            padding-right: calc(15px + env(safe-area-inset-right));
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            padding-left: calc(15px + env(safe-area-inset-left));
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #333;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .section {
            padding: 25px;
        }

        h1, h2 {
            text-align: center;
            color: #1c1e21;
        }

        .selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .selection-list li {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .selection-list li a {
            display: block;
            padding: 16px;
            text-decoration: none;
            color: #212529;
            font-weight: 500;
            text-align: center;
        }
        .selection-list li:hover {
            background-color: #e9ecef;
        }
        .back-btn {
            display: block;
            width: 100%;
            padding: 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1rem; /* 16px -> 1rem */
            margin-top: 20px;
            background-color: var(--dark-gray);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        .back-btn:hover {
            background-color: #5a6268;
        }

        .user-details-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }

        .user-details-form input {
            width: 100%;
            padding: 12px 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1rem; /* 16px -> 1rem */
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
        }

        #start-section p {
            text-align: justify;
            line-height: 1.6;
        }
        #unit-selection-info {
            text-align: center;
            font-size: 1rem;
            color: var(--dark-gray);
            margin-top: -15px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        #start-button {
            display: block;
            width: 100%;
            padding: 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1.125rem; /* 18px -> 1.125rem */
            font-weight: bold;
            color: var(--white);
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
            text-align: center;
        }
        #start-button:hover {
            background-color: #0056b3;
        }
        #start-button:disabled {
            background-color: #aab8c5;
            cursor: not-allowed;
        }

        #quiz-section {
            display: none;
        }

        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #progress-bar {
            width: 0%;
            height: 12px;
            background-color: var(--success-color);
            border-radius: 8px;
            transition: width 0.3s ease-in-out;
        }

        #progress-text {
            text-align: center;
            font-weight: 500;
            margin-top: 5px;
            color: var(--dark-gray);
        }

        #question-container {
            min-height: 120px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #question-number {
             margin-bottom: 15px;
        }

        #question-text {
            font-size: 1.2rem;
            line-height: 1.5;
            margin: 0;
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .answer-btn {
            padding: 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1.125rem; /* 18px -> 1.125rem */
            cursor: pointer;
            border: 2px solid var(--primary-color);
            background-color: var(--white);
            color: var(--primary-color);
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
            text-align: center;
        }
        .answer-btn.selected {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        #prev-button {
            width: 100%;
            padding: 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1.125rem; /* 18px -> 1.125rem */
        }

        #post-quiz-section {
            display: none;
            text-align: center;
        }

        .post-quiz-buttons {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .post-quiz-btn {
            padding: 15px;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1.125rem; /* 18px -> 1.125rem */
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: var(--white);
            text-align: center;
        }
        #send-answers-btn {
            background-color: var(--success-color);
        }
         #send-answers-btn:disabled {
            background-color: #aab8c5;
            cursor: not-allowed;
        }
        #restart-quiz-btn {
            background-color: var(--danger-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            /* --- ПОКРАЩЕННЯ: Адаптивний шрифт --- */
            font-size: 1rem; /* 16px -> 1rem */
        }
        #modal-confirm-btn {
            background-color: var(--danger-color);
            color: var(--white);
        }
        #modal-cancel-btn {
            background-color: #e9ecef;
        }

        footer {
            text-align: center;
            padding: 20px 25px 15px;
            font-size: 0.8rem;
            color: var(--dark-gray);
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }

        /* --- ПОКРАЩЕННЯ: Адаптивність на маленьких екранах --- */
        @media (max-width: 380px) {
            .answer-buttons {
                grid-template-columns: 1fr; /* Робимо одну колонку */
            }
        }
        
    </style>
</head>
<body>

    <div class="container">

        <section id="selection-section" class="section">
            <h1 id="selection-title">Оберіть підрозділ</h1>
            <div id="unit-container">
                <ul class="selection-list" id="unit-list"></ul>
            </div>
            <div id="platoon-container" style="display: none;">
                <ul class="selection-list" id="platoon-list"></ul>
                <button class="back-btn" data-target="unit-container">Назад до підрозділів</button>
            </div>
            <div id="squad-container" style="display: none;">
                <ul class="selection-list" id="squad-list"></ul>
                <button class="back-btn" data-target="platoon-container">Назад до взводів</button>
            </div>
            <div id="position-container" style="display: none;">
                 <ul class="selection-list" id="position-list"></ul>
                 <button class="back-btn" id="position-back-btn">Назад</button>
            </div>
             <div id="rank-container" style="display: none;">
                 <ul class="selection-list" id="rank-list"></ul>
                 <button class="back-btn" data-target="position-container">Назад до посад</button>
             </div>
        </section>

        <section id="start-section" class="section" style="display: none;">
            <h1>Опитувальник "Адаптивність-200"</h1>
            <h2 id="unit-selection-info"></h2>

            <div class="user-details-form">
                <input type="text" id="lastNameInput" placeholder="Прізвище" required>
                <input type="text" id="firstNameInput" placeholder="Ім'я" required>
                <input type="text" id="patronymicInput" placeholder="По батькові" required>
            </div>

            <p>
                Вам буде запропоновано 200 тверджень, що стосуються вашого життя, роботи, інтересів та схильностей. Ваше завдання — визначити своє ставлення до кожного твердження.
            </p>
            <p>
                Якщо ви погоджуєтеся з твердженням, оберіть варіант <strong>"Так"</strong>. Якщо не згодні — <strong>"Ні"</strong>.
            </p>
            <p>
                Правильних або неправильних відповідей тут бути не може, тому довго не замислюйтеся над питанням – відповідайте, виходячи з того, що більше відповідає Вашому характеру або уявленню про самого себе.
            </p>
            <button id="start-button" disabled>Почати тестування</button>
        </section>

        <section id="quiz-section" class="section" style="display:none;">
            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>
            <div id="progress-text">Питання 1 з 200</div>

            <div id="question-container">
                <h2 id="question-number">Питання № 1</h2>
                <p id="question-text"></p>
            </div>

            <div class="answer-buttons">
                <button class="answer-btn" data-answer="no">Ні</button>
                <button class="answer-btn" data-answer="yes">Так</button>
            </div>

            <div class="navigation-buttons">
                <button class="nav-btn" id="prev-button">Назад</button>
            </div>
        </section>

        <section id="post-quiz-section" class="section">
             <h2>Тест завершено</h2>
             <p>Дякуємо за ваші відповіді.</p>
             <div class="post-quiz-buttons">
                 <button id="send-answers-btn" class="post-quiz-btn">Надіслати відповіді</button>
                 <button id="restart-quiz-btn" class="post-quiz-btn">Почати з початку</button>
             </div>
        </section>

        <footer>
            <p>created by Artem Bandura</p>
        </footer>

    </div>

    <div class="modal-overlay" id="restart-modal">
        <div class="modal-content">
            <h3>Підтвердження</h3>
            <p>Ви впевнені, що хочете почати тест спочатку? Всі ваші відповіді не будуть збережені.</p>
            <div class="modal-buttons">
                <button class="modal-btn" id="modal-cancel-btn">Скасувати</button>
                <button class="modal-btn" id="modal-confirm-btn">Так, почати спочатку</button>
            </div>
        </div>
    </div>

    <script>
    window.onload = function() {
        // !!! ВАЖЛИВО: Вставте сюди ваші дані Telegram-бота !!!
        const TELEGRAM_BOT_TOKEN = '8293066297:AAEkgW8ZDGJATc0HWDfIo14os_oGCV5U7kw';
        const TELEGRAM_CHAT_ID = '-1002908922209';

        const questions = [
            "Буває, що я серджуся.", "Зазвичай вранці я прокидаюся свіжим і відпочилим.", "Зараз я приблизно такий же працездатний, як і завжди.", "Доля, безумовно, несправедлива до мене.", "Запори (закрепи) у мене бувають дуже рідко.", "Часом мені дуже хотілося покинути свій дім.", "Часом у мене бувають напади сміху або плачу, з якими я ніяк не можу справитися.", "Мені здається, що мене ніхто не розуміє.", "Вважаю, що якщо хтось заподіяв мені зло, я повинен йому відповісти тим же.", "Іноді мені в голову приходять такі нехороші думки, що краще про них нікому не розповідати.", "Мені важко зосередитися на якому-небудь завданні або роботі.", "У мене бувають дуже дивні і незвичайні переживання.", "У мене не було неприємностей через мою поведінку.", "В дитинстві свого часу я скоював дрібні крадіжки.", "Буває, у мене з’являється бажання ламати або руйнувати все навколо.", "Бувало, що я цілими днями або навіть тижнями нічого не міг робити, тому що ніяк не міг примусити себе взятися до роботи.", "Сон у мене переривчастий і неспокійний.", "Моя сім'я несхвально ставиться до роботи, яку я обрав.", "Бували випадки, що я не виконував своїх обіцянок.", "Голова у мене болить часто.", "Раз на тиждень або частіше я без жодної видимої причини раптово відчуваю жар у всьому тілі.", "Було б добре, якби майже всі закони відмінили.", "Стан мого здоров’я майже такий же, як у більшості моїх знайомих (не гірший).", "Зустрічаючи на вулиці своїх знайомих або шкільних друзів, з якими ми давно не бачилися, я вважаю за краще проходити мимо, якщо вони зі мною не заговорюють першими.", "Більшості людей, які мене знають, я подобаюся.", "Я людина товариська.", "Іноді я так наполягаю на своєму, що люди втрачають терпіння.", "Значну частину часу настрій у мене пригнічений.", "Зараз мені важко сподіватися на те, що я чого-небудь досягну у житті.", "У мене мало впевненості в собі.", "Іноді я кажу неправду.", "Зазвичай я вважаю, що життя – хороша річ.", "Я вважаю, що більшість людей здатна збрехати, щоб просунутися по службі.", "Я охоче беру участь у зібраннях та інших громадських заходах.", "Я сварюся з членами моєї сім’ї дуже рідко.", "Іноді у мене виникає сильне бажання порушити правила пристойності або кому-небудь нашкодити.", "Найважча боротьба для мене - це боротьба з самим собою.", "М’язові судоми або сіпання у мене бувають украй рідко (або майже не бувають).", "Я досить байдужий до того, що зі мною буде.", "Іноді, коли я себе недобре почуваю, я буваю дратівливим.", "Значну частину часу у мене таке відчуття, що я зробив щось не те або навіть щось погане.", "Деякі люди настільки полюбляють командувати, що мені так і кортить робити все наперекір, навіть якщо я знаю, що вони праві.", "Я часто вважаю себе зобов'язаним відстоювати те, що вважаю справедливим.", "Моя мова зараз така ж, як завжди (ні швидша, ні повільніша, немає ні хрипоти, ні невиразності).", "Я вважаю, що моє сімейне життя таке ж благополучне, як у більшості моїх знайомих.", "Мене дуже зачіпає, коли мене критикують або лають.", "Іноді у мене буває таке відчуття, що я просто повинен нанести ушкодження собі або кому-небудь іншому.", "Моя поведінка значною мірою визначається звичаями тих, хто мене оточує.", "В дитинстві у мене була така компанія, де всі прагнули бути один за одного.", "Іноді мені так і кортить з ким-небудь затіяти бійку.", "Бувало, що я висловлював свою думку про речі, в яких не розбираюся.", "Зазвичай я засинаю спокійно і мене не тривожать ніякі думки.", "Останні декілька років я почуваюсь добре.", "У мене ніколи не було ні припадків, ні судом.", "Зараз моя вага відносно постійна (я різко не худну і не повнішаю)", "Я вважаю, що мене часто карали незаслужено.", "Я тонкосльозий, легко можу заплакати.", "Я мало втомлююся.", "Я був би досить спокійним, навіть якби у кого-небудь з моєї сім'ї були неприємності через порушення закону.", "З моїм розумом коїться щось недобре.", "Щоб приховати свою сором'язливість, мені доводиться докладати великих зусиль.", "Напади запаморочення у мене бувають дуже рідко (або майже не бувають).", "Мене непокоять сексуальні (статеві) питання.", "Мені важко підтримувати розмову з людьми, з якими я щойно познайомився.", "Коли я намагаюся щось зробити, то часто помічаю, що у мене тремтять руки.", "Руки у мене такі ж спритні і моторні, як і раніше.", "Велику частину часу я відчуваю загальну слабкість.", "Іноді, коли я збентежений, я сильно потію, і мене це дратує.", "Буває, що я відкладаю на завтра те, що повинен зробити сьогодні.", "Думаю, що я людина приречена.", "Бували випадки, коли мені було важке утриматися від того, щоб що-небудь не поцупити в кого-небудь або де-небудь, наприклад у магазині.", "Я зловживав спиртними напоями.", "Я часто про що-небудь хвилююся.", "Мені б хотілося бути членом декількох гуртків або об’єднань.", "Я рідко задихаюся, і у мене не буває посиленого серцебиття.", "Все своє життя я суворо дотримуюсь принципів, заснованих на почутті обов’язку.", "Траплялося, що я перешкоджав або поступав наперекір людям просто із принципу, а не тому, що справа була дійсно важливою.", "Якщо мені не загрожує штраф і машин поблизу немає, я можу перейти вулицю там, де бажаю, а не там де дозволено.", "Я завжди був незалежним і вільним від контролю з боку сім'ї.", "У мене бували періоди такої сильної схвильованості, що я навіть не міг всидіти на місці.", "Часто мої вчинки тлумачилися не вірно.", "Мої батьки або інші члени моєї сім’ї прискіпуються до мене більше, ніж треба.", "Хтось керує моїми думками.", "Люди байдужі до того, що з тобою трапиться.", "Мені подобається бути в компанії, де всі жартують один над одним.", "В школі я засвоював матеріал повільніше, аніж інші учні.", "Я цілком впевнений у собі.", "Найбезпечніше – нікому не довіряти.", "Раз на тиждень або частіше я буваю дуже збудженим і схвильованим.", "Коли я знаходжуся в компанії, мені важко знайти відповідну тему для розмови.", "Мені легко примусити інших людей боятися мене, і іноді я це роблю заради забави.", "У грі я вважаю за краще вигравати.", "Безглуздо засуджувати людину, яка обманула того, хто сам дозволяє себе обманнувати.", "Хтось намагається впливати на мої думки.", "Я щодня випиваю багато води.", "Найщасливішим я буваю наодинці.", "Я обурююся кожного разу, коли дізнаюся, що злочинець з якої-небудь причини залишився непокараним.", "У моєму житті був один або декілька випадків, коли я відчував, що хтось за допомогою гіпнозу примушує мене скоювати ті або інші вчинки.", "Я дуже рідко заговорюю з людьми першим.", "У мене ніколи не було проблем із законом.", "Мені приємно мати серед своїх знайомих значних людей, це ніби додає мені ваги у власних очах.", "Іноді без жодної причини у мене раптом наступають періоди незвичайної веселості.", "Життя для мене майже завжди пов'язане з напруженням.", "У школі мені було дуже важко виступати перед класом.", "Люди проявляють щодо мене стільки співчуття і симпатії, наскільки я заслуговую.", "Я відмовляюся грати в деякі ігри, тому що це у мене погано виходить.", "Мені здається, що я знаходжу друзів з такою ж легкістю, як і інші люди.", "Мені неприємно, коли навколо мене є люди.", "Як правило, мені не щастить.", "Мене легко збити з пантелику.", "Деякі з членів моєї сім'ї скоювали вчинки, які мене лякали.", "Іноді у мене бувають напади сміху або плачу, з якими я ніяк не можу справитися.", "Мені важко приступити до виконання нового завдання або розпочати нову справу.", "Якби люди не були налаштовані проти мене, я досягнув би у житті набагато більшого.", "Мені здається, що мене ніхто не розуміє.", "Серед моїх знайомих є люди, які мені не подобаються.", "Я легко втрачаю терпіння з людьми.", "Часто у новій обстановці я переживаю почуття тривоги.", "Часто мені хочеться померти.", "Іноді я такий збуджений, що мені важко заснути.", "Часто я переходжу на іншу сторону вулиці, щоб уникнути зустрічі з тим, кого я побачив.", "Бувало, що я кидав розпочату справу, оскільки боявся, що я не справлюся з нею.", "Майже щодня трапляється що-небудь, що лякає мене.", "Навіть серед людей я зазвичай відчуваю себе самотнім.", "Я переконаний, що існує лише одне єдине правильне розуміння сенсу життя.", "В гостях я частіше сиджу де-небудь осторонь або розмовляю з ким-небудь одним, аніж беру участь у загальних розвагах.", "Мені часто кажуть, що я запальний.", "Буває, що я з ким-небудь пліткую.", "Часто мені неприємно, коли я намагаюся застерегти кого-небудь від помилок, а мене розуміють неправильно.", "Я часто звертаюся до людей за порадою.", "Часто, навіть тоді, коли усе для мене складається добре, я відчуваю, що мені усе байдуже.", "Мене досить важко вивести з себе.", "Коли я намагаюся вказати людям на їх помилки або допомогти, вони часто розуміють мене неправильно.", "Зазвичай я спокійний, і мене нелегко вивести з душевної рівноваги.", "Я заслуговую суворого покарання за свої провини.", "Мені притаманно так сильно переживати свої розчарування, що я не можу примусити себе не думати про них.", "Часом мені здається, що я ні на що не здатний.", "Бувало, що під час обговорення деяких питань я, особливо не замислюючись, погоджувався з думкою інших.", "Мене дуже хвилюють різного роду нещастя.", "Мої переконання і погляди непохитні.", "Я вважаю, що можна, не порушуючи закон, спробувати знайти в ньому \"лазівку\".", "Є люди, які мені настільки неприємні, що я в глибині душі радію, коли вони одержують прочухан за що-небудь.", "У мене бували періоди, коли через хвилювання я втрачав сон.", "Я відвідую різні громадські заходи, тому що це дозволяє мені бувати серед людей.", "Можна пробачити людям порушення тих правил, які вони вважають нерозумними.", "У мене є погані звички, настільки сильні, що боротися з ними просто марно.", "Я охоче знайомлюся з новими людьми.", "Буває, що непристойний жарт у мене викликає сміх.", "Якщо справа йде у мене погано, то мені відразу хочеться все кинути.", "Я вважаю за краще діяти у відповідності до власних планів, а не слідувати вказівкам інших людей.", "Мені подобається, коли оточуючі знають мою точку зору.", "Якщо я поганої думки про людину або навіть зневажаю її, я не прагну приховати це від неї.", "Я людина нервова і легко збудлива.", "Все у мене виходить погано, не так як треба.", "Майбутнє здається мені безнадійним.", "Люди досить легко можуть змінити мою думку, навіть якщо до цього вона здавалася мені остаточною.", "Кілька разів на тиждень у мене буває відчуття, що повинно трапитися щось жахливе.", "Значну частину часу я почуваюсь втомленим.", "Я люблю бувати на вечірках і просто в компаніях.", "Я прагну ухилятися від конфліктів і скрутних ситуацій.", "Мене дуже дратує, що я забуваю, куди кладу речі.", "Пригодницькі розповіді мені подобаються більше, ніж оповідання про любов.", "Якщо я схочу зробити щось, але оточуючі вважають, що цього робити не варто, я можу легко відмовитися від своїх намірів.", "Безглуздо засуджувати людей, які прагнуть урвати від життя все, що можуть.", "Мені байдуже, що про мене думають інші.", "Я абсолютно не пристосований до військової служби, і це мене дуже лякає.", "Я переконаний, що чоловіки повинні служити у збройних силах тільки за власним бажанням.", "Останнім часом у мене все частіше і частіше трапляються \"промахи\" і невдачі по службі.", "Найбільші труднощі для мене під час служби – це необхідність підкорятися командирам і начальникам.", "Тим правилам, які, на мій погляд, несправедливі, я завжди прагну протидіяти.", "Мені хотілося б випробувати себе серйозною і небезпечною справою.", "Мене довго не залишає почуття образи, заподіяної товаришами.", "Жити за військовим розпорядком для мене просто нестерпно.", "Я сумніваюся, чи зможу я зі своїм здоров'ям витримати всі навантаження військової служби.", "Я заздрю тим, хто зміг ухилитися від військової служби.", "Я відчуваю все більше і більше розчарування стосовно моєї нинішньої військової спеціальності.", "Я часто розгублююся у складних і небезпечних ситуаціях.", "Мені хотілося б служити у десанті або частинах спецназу.", "Із службою у мене нічого не виходить (як кажуть, \"не клеїться\"). Часто думаю: \"не моя це справа\".", "Коли мною хтось командує, це викликає у мене внутрішній протест.", "Мені завжди було важко пристосовуватися до нового колективу.", "Під час подальшої служби я був би не проти послужити там, де небезпечно і де ведуться бойові дії.", "Присяга на вірність Вітчизні у сучасних умовах втратила свою актуальність.", "Мені завжди було нелегко пристосовуватися до нових умов життя.", "У складних ситуаціях я не можу швидко приймати правильні рішення.", "Я впевнений, що в майбутньому не стану укладати або продовжувати контракт на проходження військової служби.", "У мене бувають періоди похмурої дратівливості, під час яких я \"зриваю зло\" на оточуючих.", "Я ледве витримую фізичні навантаження, пов’язані з моєю професійною діяльністю.", "Я достатньо спокійно відношуся до необхідності брати участь в тривалих і небезпечних відрядженнях.", "Навряд чи я схочу присвятити все своє життя військовій професії (залишитися на службу за контрактом, поступити у військовий навчальний заклад).", "\"За компанію\" з товаришами я можу вжити неабияку кількість алкоголю (перевищити свою звичайну \"норму\").", "У компаніях, де я часто буваю, друзі іноді палять наркотичну \"травичку\", і я їх за це не засуджую.", "Останнім часом, щоб не \"зірватися\", я був вимушений приймати заспокійливі ліки.", "Мої батьки (родичі) часто виказували побоювання у зв'язку з моїми випивками.", "Немає нічого поганого, коли люди намагаються випробувати на собі незвичайні стани, вживаючи деякі речовини.", "У стані агресії я здатний багато на що.", "Я різкий і жорстокий з оточуючими.", "Якщо хтось заподіяв мені зло, я вважаю зобов'язаним відплатити йому тим же (\"око за око, зуб за зуб\").", "Можна погодитися з тим, що я не надто схильний виконувати багато наказів, вважаючи їх нерозумними.", "Я думаю, що будь-яке положення законів і військових статутів можна тлумачити неоднозначно."
        ];

        // --- ВИПРАВЛЕННЯ: Додано коми в усі об'єкти даних ---
        const keys = {
            'Достовірність': { no: [1, 10, 19, 31, 51, 69, 78, 92, 101, 116, 128, 138, 148] },
            'Поведінкова регуляція (ПР)': {
                yes: [4, 6, 7, 8, 11, 12, 15, 16, 17, 18, 20, 21, 28, 29, 30, 36, 37, 39, 40, 41, 47, 57, 60, 63, 65, 67, 68, 70, 73, 80, 82, 83, 84, 86, 89, 94, 95, 96, 98, 102, 103, 108, 109, 110, 111, 112, 113, 115, 117, 118, 119, 120, 122, 123, 124, 125, 127, 129, 131, 135, 136, 137, 139, 143, 146, 149, 153, 154, 155, 156, 157, 158, 161, 162],
                no: [2, 3, 5, 23, 25, 32, 38, 44, 45, 52, 53, 54, 55, 58, 62, 66, 75, 87, 105, 132, 134, 140]
            },
            'Комунікативний потенціал (КП)': {
                yes: [9, 24, 27, 43, 46, 61, 64, 81, 88, 90, 99, 104, 106, 114, 121, 126, 133, 142, 151, 152],
                no: [26, 34, 35, 48, 49, 74, 85, 107, 130, 144, 147, 159]
            },
            'Моральна нормативність (МН)': {
                yes: [14, 22, 33, 42, 50, 56, 59, 71, 72, 77, 79, 91, 93, 141, 145, 150, 164, 165],
                no: [13, 76, 97, 100, 160, 163]
            },
            'Військово-професійна спрямованість (ВПС)': {
                yes: [166, 167, 168, 169, 170, 172, 173, 174, 175, 176, 177, 179, 180, 181, 183, 184, 185, 186, 187, 188, 190],
                no: [171, 178, 182, 189]
            },
            'Схильність до девіантних форм поведінки (ДАП)': {
                yes: [6, 9, 14, 15, 22, 36, 39, 42, 47, 50, 56, 59, 71, 72, 91, 93, 117, 127, 141, 145, 151, 152, 164, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200],
                no: [13, 100, 163]
            },
            'Суїцидальний ризик (СР)': {
                yes: [4, 8, 10, 28, 29, 39, 41, 47, 70, 84, 115, 119, 124, 136, 137, 149, 154, 155],
                no: [32, 105]
            }
        };

        const units = [
            { name: '1 Рота охорони', type: 'company', platoons: 4, squads: 6 },
            { name: '2 Рота охорони', type: 'company', platoons: 4, squads: 6 },
            { name: '3 Рота охорони', type: 'company', platoons: 4, squads: 6 },
            { name: '4 Рота охорони', type: 'company', platoons: 4, squads: 6 },
            { name: '5 Рота охорони', type: 'company', platoons: 4, squads: 6 },
            { name: 'Відділення забезпечення', type: 'unit' },
            { name: 'Відділення технічного обслуговування', type: 'unit' },
            { name: 'Медичний пункт', type: 'unit' }
        ];

        const positions = [
            "Головний сержант-командир відділення",
            "Командир відділення",
            "Стрілець",
            "Водій-стрілець"
        ];

        const ranks = [
            "Солдат", "Старший солдат", "Молодший сержант", "Сержант",
            "Старший сержант", "Головний сержант", "Штаб-сержант"
        ];

        const stenScales = {
            'ПР': [
                { sten: 1, range: [57, Infinity] }, { sten: 2, range: [46, 56] },
                { sten: 3, range: [35, 45] }, { sten: 4, range: [27, 34] },
                { sten: 5, range: [19, 26] }, { sten: 6, range: [13, 18] },
                { sten: 7, range: [9, 12] },  { sten: 8, range: [6, 8] },
                { sten: 9, range: [5, 5] },   { sten: 10, range: [0, 4] }
            ],
            'КП': [
                { sten: 1, range: [23, Infinity] }, { sten: 2, range: [20, 22] },
                { sten: 3, range: [18, 19] }, { sten: 4, range: [15, 17] },
                { sten: 5, range: [13, 14] }, { sten: 6, range: [11, 12] },
                { sten: 7, range: [9, 10] },  { sten: 8, range: [7, 8] },
                { sten: 9, range: [6, 6] },   { sten: 10, range: [0, 5] }
            ],
            'МН': [
                { sten: 1, range: [17, Infinity] }, { sten: 2, range: [16, 16] },
                { sten: 3, range: [14, 15] }, { sten: 4, range: [12, 13] },
                { sten: 5, range: [10, 11] }, { sten: 6, range: [8, 9] },
                { sten: 7, range: [7, 7] },   { sten: 8, range: [5, 6] },
                { sten: 9, range: [4, 4] },   { sten: 10, range: [0, 3] }
            ],
             'ВПС': [
                { sten: 1, range: [18, Infinity] }, { sten: 2, range: [16, 17] },
                { sten: 3, range: [14, 15] }, { sten: 4, range: [11, 13] },
                { sten: 5, range: [8, 10] }, { sten: 6, range: [5, 7] },
                { sten: 7, range: [4, 4] },   { sten: 8, range: [2, 3] },
                { sten: 9, range: [1, 1] },   { sten: 10, range: [0, 0] }
            ],
            'ДАП': [
                { sten: 1, range: [25, Infinity] }, { sten: 2, range: [21, 24] },
                { sten: 3, range: [18, 20] }, { sten: 4, range: [15, 17] },
                { sten: 5, range: [12, 14] }, { sten: 6, range: [10, 11] },
                { sten: 7, range: [8, 9] },  { sten: 8, range: [6, 7] },
                { sten: 9, range: [4, 5] },   { sten: 10, range: [0, 3] }
            ],
            'СР': [
                { sten: 1, range: [15, Infinity] }, { sten: 2, range: [10, 14] },
                { sten: 3, range: [7, 9] }, { sten: 4, range: [5, 6] },
                { sten: 5, range: [4, 4] }, { sten: 6, range: [3, 3] },
                { sten: 7, range: [2, 2] },  { sten: 8, range: [1, 1] },
                { sten: 9, range: [0, 0] },   { sten: 10, range: [0, 0] }
            ]
        };

        const oapScale = [
            { level: 4, name: "Низька стійкість", range: [87, Infinity], sten: 1 },
            { level: 4, name: "Низька стійкість", range: [75, 86], sten: 2 },
            { level: 3, name: "Задовільна стійкість", range: [63, 74], sten: 3 },
            { level: 3, name: "Задовільна стійкість", range: [51, 62], sten: 4 },
            { level: 2, name: "Достатня стійкість", range: [40, 50], sten: 5 },
            { level: 2, name: "Достатня стійкість", range: [31, 39], sten: 6 },
            { level: 2, name: "Достатня стійкість", range: [25, 30], sten: 7 },
            { level: 1, name: "Висока стійкість", range: [21, 24], sten: 8 },
            { level: 1, name: "Висока стійкість", range: [18, 20], sten: 9 },
            { level: 1, name: "Висока стійкість", range: [0, 17], sten: 10 }
        ];

        const oapInterpretations = {
            1: "Високий рівень розвитку адаптаційних можливостей особистості. Повністю відповідає вимогам, що пред'являються до військовослужбовців в умовах бойової діяльності.",
            2: "Достатній рівень розвитку адаптаційних можливостей особистості. В основному відповідає вимогам, що пред'являються до військовослужбовців в умовах бойової діяльності.",
            3: "Задовільний рівень розвитку адаптаційних можливостей особистості. Мінімально відповідає вимогам, що пред'являються до військовослужбовців в умовах бойової діяльності.",
            4: "Недостатній рівень розвитку адаптаційних можливостей особистості. Не відповідає вимогам, що пред'являються до військовослужбовців в умовах бойової діяльності."
        };

        const interpretations = {
            'Достовірність': (score) => {
                if (score >= 10) return "Результати обстеження НЕДОСТОВІРНІ. Прагнення відповідати соціально бажаному типу особистості. Потрібне додаткове поглиблене обстеження.";
                if (score >= 6) return "ДОСТАТНЯ достовірність результатів. Наявні окремі ознаки соціальної бажаності.";
                return "ВИСОКА достовірність результатів обстеження.";
            },
            'ПР': {
                1: "Вкрай високий рівень нервово-психічної нестійкості. Ознаки граничних нервово-психічних розладів. Вкрай низька толерантність до навантажень. Працездатність різко знижена.",
                2: "Виражені ознаки нервово-психічної нестійкості. Низька толерантність до навантажень. Адаптація протікає хворобливо. Ймовірний зрив професійної діяльності.",
                3: "Окремі ознаки нервово-психічної нестійкості. Недостатня толерантність до навантажень. Адаптація ускладнена. При високих навантаженнях можливий зрив діяльності.",
                4: "Дещо понижений рівень нервово-психічної стійкості. Нестабільний рівень працездатності в ускладнених умовах. Адаптація до нових умов ускладнена.",
                5: "В цілому достатній рівень нервово-психічної стійкості. Стійка працездатність у звичних умовах. При тривалих навантаженнях можливе тимчасове погіршення якості діяльності.",
                6: "Достатній рівень нервово-психічної стійкості і поведінкової регуляції. Достатня стійкість до дії стрес-чинників.",
                7: "Достатньо високий рівень нервово-психічної стійкості. Висока працездатність в ускладнених умовах. Висока стійкість до стрес-чинників.",
                8: "Високий рівень нервово-психічної стійкості і поведінкової регуляції. Високий рівень працездатності, у тому числі і в умовах вираженого стресу.",
                9: "Високий рівень нервово-психічної стійкості і поведінкової регуляції. Високий рівень працездатності, у тому числі і в умовах вираженого стресу.",
                10: "Високий рівень нервово-психічної стійкості і поведінкової регуляції. Високий рівень працездатності, у тому числі і в умовах вираженого стресу."
            },
            'КП': {
                1: "Вкрай низький рівень комунікативних здібностей. Виражені ознаки акцентуації характеру. Адаптація до колективу вкрай хвороблива. Високий рівень конфліктності.",
                2: "Рівень комунікативних здібностей низький. Ознаки акцентуації характеру. Адаптація розтягнута у часі. Схильність до підвищеної конфліктності. Хворобливо реагує на критику.",
                3: "Понижений рівень комунікативних здібностей. Наявність окремих ознак акцентуації характеру. Адаптація до нового колективу викликає значні ускладнення.",
                4: "Задовільний рівень комунікативних здібностей. На початковому етапі адаптації можуть виникати ускладнення. Не завжди правильно будує міжперсональні стосунки.",
                5: "Рівень комунікативних здібностей середній. В цілому без особливих ускладнень адаптується. Здатний коригувати свою поведінку, неконфліктний.",
                6: "Достатній рівень комунікативних здібностей. Швидко адаптується у новому колективі, неконфліктний, адекватно реагує на критику.",
                7: "Достатньо високий рівень комунікативних здібностей. Швидко адаптується, легко встановлює контакти, неконфліктний.",
                8: "Високий рівень комунікативних здібностей. Швидко адаптується у новому колективі. Легко встановлює контакти з оточуючими. Неконфліктний.",
                9: "Високий рівень комунікативних здібностей. Швидко адаптується у новому колективі. Легко встановлює контакти з оточуючими. Неконфліктний.",
                10: "Високий рівень комунікативних здібностей. Швидко адаптується у новому колективі. Легко встановлює контакти з оточуючими. Неконфліктний."
            },
            'МН': {
                1: "Вкрай низький рівень соціалізації. Діє згідно власних планів, не рахуючись з думкою оточуючих. Ігнорує загальноприйняті норми і правила.",
                2: "Низький рівень соціалізації. Не прагне дотримуватися загальноприйнятих норм. Переважають егоцентричні тенденції. Може діяти в обхід існуючих заборон.",
                3: "Недостатній рівень соціалізації. Не прагне дотримуватися загальноприйнятих норм. Особистісні інтереси переважають над груповими.",
                4: "Задовільний рівень соціалізації. Не завжди орієнтований на дотримання загальноприйнятих норм. Особистісні інтереси, як правило, переважають над груповими.",
                5: "В цілому достатній рівень соціалізації. Прагне дотримуватися загальноприйнятих норм поведінки. Групові інтереси, як правило, переважають над особистісними.",
                6: "Достатній рівень соціалізації. Орієнтований на дотримання загальноприйнятих норм поведінки. Групові інтереси переважають над особистісними.",
                7: "Достатньо високий рівень соціалізації. Орієнтований на дотримання загальноприйнятих норм. Групові інтереси переважають над особистісними.",
                8: "Високий рівень соціалізації. Суворо орієнтований на загальноприйняті норми поведінки. Групові інтереси ставить вище особистісних.",
                9: "Дуже високий рівень соціалізації. Суворо орієнтований на загальноприйняті норми. Виражені альтруїстські якості.",
                10: "Дуже високий рівень соціалізації. Суворо орієнтований на загальноприйняті норми. Виражені альтруїстські якості."
            },
            'ВПС': {
                1: "Низький рівень військово-професійної спрямованості. Не задоволений своєю військовою професійною діяльністю і службовим призначенням.",
                2: "Низький рівень військово-професійної спрямованості. Не задоволений своєю військовою професійною діяльністю і службовим призначенням.",
                3: "Низький рівень військово-професійної спрямованості. Не задоволений своєю військовою професійною діяльністю і службовим призначенням.",
                4: "Недостатній рівень військово-професійної спрямованості. Не повною мірою задоволений діяльністю. Орієнтація на продовження служби сумнівна.",
                5: "В цілому достатній рівень військово-професійної спрямованості. Орієнтований на продовження професійної діяльності.",
                6: "Достатній рівень військово-професійної спрямованості. Стійка орієнтація на продовження професійної діяльності.",
                7: "Достатній рівень військово-професійної спрямованості. Стійка орієнтація на продовження професійної діяльності.",
                8: "Високий рівень військово-професійної спрямованості. Виражене бажання продовжувати професійну діяльність, у тому числі і в особливих умовах.",
                9: "Високий рівень військово-професійної спрямованості. Виражене бажання продовжувати професійну діяльність, у тому числі і в особливих умовах.",
                10: "Високий рівень військово-професійної спрямованості. Виражене бажання продовжувати професійну діяльність, у тому числі і в особливих умовах."
            },
            'ДАП': {
                1: "Наявність виразних ознак девіантних форм поведінки. Виражені агресивні реакції. Не орієнтований на дотримання соціально ухвалених норм.",
                2: "Наявність виразних ознак девіантних форм поведінки. Виражені агресивні реакції. Не орієнтований на дотримання соціально ухвалених норм.",
                3: "Наявність деяких ознак девіантних форм поведінки. Агресивні реакції. Схильний допускати порушення соціально ухвалених норм.",
                4: "Наявність деяких ознак девіантних форм поведінки. Агресивні реакції. Схильний допускати порушення соціально ухвалених норм.",
                5: "В цілому виражені ознаки девіантних форм поведінки відсутні. Іноді допускає порушення соціально ухвалених норм поведінки.",
                6: "Відсутність ознак девіантних форм поведінки. Орієнтація на дотримання соціально ухвалених норм.",
                7: "Відсутність ознак девіантних форм поведінки. Орієнтація на дотримання соціально ухвалених норм.",
                8: "Відсутність ознак девіантних форм поведінки. Орієнтація на дотримання соціально ухвалених норм.",
                9: "Відсутність ознак девіантних форм поведінки. Орієнтація на дотримання соціально ухвалених норм.",
                10: "Відсутність ознак девіантних форм поведінки. Орієнтація на дотримання соціально ухвалених норм."
            },
            'СР': {
                1: "Відзначена наявність виразних ознак суїцидальної схильності. Можуть виникнути думки про суїцидальний шантаж або закінчені суїцидальні дії.",
                2: "Відзначена наявність виразних ознак суїцидальної схильності. Можуть виникнути думки про суїцидальний шантаж або закінчені суїцидальні дії.",
                3: "Відзначена наявність окремих ознак суїцидальної схильності. Можуть виникнути думки суїцидальної спрямованості.",
                4: "Відзначена наявність окремих ознак суїцидальної схильності. Можуть виникнути думки суїцидальної спрямованості.",
                5: "В цілому виразних ознак суїцидальної схильності не виявлено. Наявні окремі ознаки труднощів в міжперсональних взаємостосунках.",
                6: "Відсутність ознак суїцидального ризику.",
                7: "Відсутність ознак суїцидального ризику.",
                8: "Відсутність ознак суїцидального ризику.",
                9: "Відсутність ознак суїцидального ризику.",
                10: "Відсутність ознак суїцидального ризику."
            }
        };

        let currentQuestionIndex = 0;
        const userAnswers = new Array(questions.length).fill(null);
        let selectionState = {
            unit: null,
            platoon: null,
            squad: null,
            position: null,
            rank: null,
            isCompany: false
        };

        // DOM Elements
        const allSections = document.querySelectorAll('.section');
        const selectionSection = document.getElementById('selection-section');
        const startSection = document.getElementById('start-section');
        const quizSection = document.getElementById('quiz-section');
        const postQuizSection = document.getElementById('post-quiz-section');

        const selectionTitle = document.getElementById('selection-title');
        const unitContainer = document.getElementById('unit-container');
        const platoonContainer = document.getElementById('platoon-container');
        const squadContainer = document.getElementById('squad-container');
        const positionContainer = document.getElementById('position-container');
        const rankContainer = document.getElementById('rank-container');

        const unitList = document.getElementById('unit-list');
        const platoonList = document.getElementById('platoon-list');
        const squadList = document.getElementById('squad-list');
        const positionList = document.getElementById('position-list');
        const rankList = document.getElementById('rank-list');

        const unitSelectionInfo = document.getElementById('unit-selection-info');

        const startButton = document.getElementById('start-button');
        const lastNameInput = document.getElementById('lastNameInput');
        const firstNameInput = document.getElementById('firstNameInput');
        const patronymicInput = document.getElementById('patronymicInput');

        const questionTextEl = document.getElementById('question-text');
        const questionNumberEl = document.getElementById('question-number');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const answerButtons = document.querySelectorAll('.answer-btn');
        const prevButton = document.getElementById('prev-button');

        const sendAnswersBtn = document.getElementById('send-answers-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const restartModal = document.getElementById('restart-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- Generic Functions ---
        function showSection(sectionId) {
            allSections.forEach(s => s.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
        }

        function populateList(listElement, items, type, nameKey = null) {
            listElement.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                const itemName = nameKey ? item[nameKey] : item;
                const itemType = nameKey ? item.type : type;
                li.innerHTML = `<a href="#" data-type="${itemType}" data-name="${itemName}">${itemName}</a>`;
                listElement.appendChild(li);
            });
        }


        // --- Selection Logic ---
        function showSelectionScreen(containerId) {
            const containers = [unitContainer, platoonContainer, squadContainer, positionContainer, rankContainer];
            containers.forEach(c => c.style.display = 'none');
            document.getElementById(containerId).style.display = 'block';

            if (containerId === 'unit-container') selectionTitle.textContent = 'Оберіть підрозділ';
            if (containerId === 'platoon-container') selectionTitle.textContent = `Оберіть взвод (${selectionState.unit})`;
            if (containerId === 'squad-container') selectionTitle.textContent = `Оберіть відділення (${selectionState.platoon})`;
            if (containerId === 'position-container') selectionTitle.textContent = 'Оберіть посаду';
            if (containerId === 'rank-container') selectionTitle.textContent = 'Оберіть звання';
        }

        function updatePositionBackButton() {
            const backBtn = document.getElementById('position-back-btn');
            const target = selectionState.isCompany ? 'squad-container' : 'unit-container';
            backBtn.setAttribute('data-target', target);
        }

        selectionSection.addEventListener('click', (e) => {
            e.preventDefault();
            const targetLink = e.target.closest('a');
            const backBtn = e.target.closest('.back-btn');

            if (targetLink) {
                const type = targetLink.dataset.type;
                const name = targetLink.dataset.name;
                const selectedUnitConfig = units.find(u => u.name === name);

                if (type === 'company') {
                    selectionState.unit = name;
                    selectionState.isCompany = true;
                    populateList(platoonList, Array.from({length: selectedUnitConfig.platoons}, (_, i) => `${i+1} Взвод охорони`), 'platoon');
                    showSelectionScreen('platoon-container');
                } else if (type === 'unit') {
                    selectionState.unit = name;
                    selectionState.isCompany = false;
                    updatePositionBackButton();
                    populateList(positionList, positions, 'position');
                    showSelectionScreen('position-container');
                } else if (type === 'platoon') {
                    selectionState.platoon = name;
                    const companyForPlatoon = units.find(u => u.name === selectionState.unit);
                    populateList(squadList, Array.from({length: companyForPlatoon.squads}, (_, i) => `${i+1} Відділення охорони`), 'squad');
                    showSelectionScreen('squad-container');
                } else if (type === 'squad') {
                    selectionState.squad = name;
                    updatePositionBackButton();
                    populateList(positionList, positions, 'position');
                    showSelectionScreen('position-container');
                } else if (type === 'position') {
                    selectionState.position = name;
                    populateList(rankList, ranks, 'rank');
                    showSelectionScreen('rank-container');
                } else if (type === 'rank') {
                    selectionState.rank = name;
                    displayStartScreen();
                }
            } else if (backBtn) {
                showSelectionScreen(backBtn.dataset.target);
            }
        });

        function displayStartScreen() {
              let displayText = `6 батальйону охорони / ${selectionState.unit}`;
            if (selectionState.platoon) displayText += ` / ${selectionState.platoon}`;
            if (selectionState.squad) displayText += ` / ${selectionState.squad}`;

            unitSelectionInfo.innerHTML = `
                ${displayText} <br>
                ${selectionState.position} / ${selectionState.rank}
            `;
            showSection('start-section');
            checkInputs();
        }

        // --- Quiz Logic ---
        startButton.addEventListener('click', () => {
            showSection('quiz-section');
            showQuestion();
        });

        prevButton.addEventListener('click', showPreviousQuestion);

        function handleNameInput(event) {
            const sanitizedValue = event.target.value.replace(/[\d!"#$%&'()*+,-./:;<=>?@[\\\]^_`{|}~]/g, '');
            if (event.target.id === 'lastNameInput') {
                event.target.value = sanitizedValue.toUpperCase();
            } else {
                event.target.value = sanitizedValue;
            }
            checkInputs();
        }

        [lastNameInput, firstNameInput, patronymicInput].forEach(input => input.addEventListener('input', handleNameInput));

        let isProcessingAnswer = false;
        function processAnswer(answer) {
            if (isProcessingAnswer) return;
            isProcessingAnswer = true;

            userAnswers[currentQuestionIndex] = answer;
            updateAnswerButtons();
            setTimeout(() => {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    showSection('post-quiz-section');
                }
                isProcessingAnswer = false;
            }, 200);
        }

        document.querySelector('.answer-btn[data-answer="yes"]').addEventListener('click', () => processAnswer('yes'));
        document.querySelector('.answer-btn[data-answer="no"]').addEventListener('click', () => processAnswer('no'));

        function checkInputs() {
            const allFilled = lastNameInput.value.trim() && firstNameInput.value.trim() && patronymicInput.value.trim();
            startButton.disabled = !allFilled;
        }

        function showQuestion() {
            questionNumberEl.textContent = `Питання № ${currentQuestionIndex + 1}`;
            questionTextEl.textContent = questions[currentQuestionIndex];
            updateProgress();
            updateNavigationButtons();
            updateAnswerButtons();
        }

        function updateProgress() {
            const answeredCount = userAnswers.filter(a => a !== null).length;
            const progressPercentage = (answeredCount / questions.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            progressText.textContent = `Відповіли на ${answeredCount} з ${questions.length}`;
        }

        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
        }

        function updateAnswerButtons() {
            answerButtons.forEach(btn => btn.classList.remove('selected'));
            const currentAnswer = userAnswers[currentQuestionIndex];
            if (currentAnswer) {
                const selectedBtn = document.querySelector(`.answer-btn[data-answer="${currentAnswer}"]`);
                if(selectedBtn) selectedBtn.classList.add('selected');
            }
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function calculateResults() {
            const scores = {};
            for (const scale in keys) {
                scores[scale] = 0;
                const keyData = keys[scale];
                if (keyData.yes) {
                    keyData.yes.forEach(qNum => {
                        if (userAnswers[qNum - 1] === 'yes') scores[scale]++;
                    });
                }
                if (keyData.no) {
                    keyData.no.forEach(qNum => {
                        if (userAnswers[qNum - 1] === 'no') scores[scale]++;
                    });
                }
            }
            return scores;
        }

        // --- Post-Quiz and Results Logic ---

        restartQuizBtn.addEventListener('click', () => {
            restartModal.style.display = 'flex';
        });

        modalCancelBtn.addEventListener('click', () => {
            restartModal.style.display = 'none';
        });

        modalConfirmBtn.addEventListener('click', () => {
            location.reload();
        });

        async function sendAnswers() {
            sendAnswersBtn.disabled = true;
            sendAnswersBtn.textContent = 'Надсилання...';

            if (TELEGRAM_BOT_TOKEN === 'YOUR_BOT_TOKEN_HERE' || TELEGRAM_CHAT_ID === 'YOUR_CHAT_ID_HERE') {
                alert('Помилка: Не налаштовано Telegram-бот. Зверніться до адміністратора.');
                sendAnswersBtn.disabled = false;
                sendAnswersBtn.textContent = 'Надіслати відповіді';
                return;
            }

            const scores = calculateResults();
            const txtBlob = generateTxtReport(scores, true);
            const xlsxBlob = await generateXlsxReport(true);

            const txtCaption = generateTelegramCaption(scores);
            const xlsxCaption = `Деталізовані відповіді для: ${lastNameInput.value} ${firstNameInput.value}`;

            try {
                const txtResponse = await sendDocumentToTelegram(txtBlob, `${getFileName()}.txt`, txtCaption);
                if (!txtResponse.ok) throw new Error(txtResponse.description);

                const xlsxResponse = await sendDocumentToTelegram(xlsxBlob, `${getFileName()}.xlsx`, xlsxCaption);
                if (!xlsxResponse.ok) throw new Error(xlsxResponse.description);

                postQuizSection.innerHTML = '<h2>Відповіді успішно надіслано!</h2><p>Ця сторінка автоматично перезавантажиться за 5 секунд.</p>';
                setTimeout(() => location.reload(), 5000);

            } catch (error) {
                alert(`Помилка відправки в Telegram: ${error.message}`);
                sendAnswersBtn.disabled = false;
                sendAnswersBtn.textContent = 'Надіслати відповіді';
            }
        }

        async function sendDocumentToTelegram(blob, fileName, caption) {
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID);
            formData.append('document', blob, fileName);
            formData.append('caption', caption);
            formData.append('disable_notification', true);

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`;

            const response = await fetch(url, {
                method: 'POST',
                body: formData,
            });
            return await response.json();
        }

        sendAnswersBtn.addEventListener('click', sendAnswers);

        function getFileName() {
            // Формуємо частину з іменем: тільки прізвище та ім'я
            const namePart = `${lastNameInput.value}_${firstNameInput.value}`;
        
            // Отримуємо рядок з назвою підрозділу
            const unitString = getUnitPathForFileName(true);
        
            // Беремо тільки звання, посаду ігноруємо
            const rank = selectionState.rank.replace(/ /g, '_');
        
            // Збираємо фінальну назву файлу без посади
            return `${unitString}_${rank}_${namePart}`;
        }

        function getSten(scaleKey, rawScore) {
            const scale = stenScales[scaleKey];
            if (!scale) return null;
            for (const item of scale) {
                if (rawScore >= item.range[0] && (item.range[1] === Infinity || rawScore <= item.range[1])) {
                    return item.sten;
                }
            }
            return null;
        }

        function getOapResult(oapRawScore) {
            for (const item of oapScale) {
                 if (oapRawScore >= item.range[0] && (item.range[1] === Infinity || oapRawScore <= item.range[1])) {
                     return { ...item, interpretation: oapInterpretations[item.level] };
                 }
            }
            return { level: 'N/A', name: 'N/A', sten: 'N/A', interpretation: 'Не вдалося визначити рівень.' };
        }

        function generateInterpretation(scores) {
            let fullText = "ВИСНОВОК ЗА РЕЗУЛЬТАТАМИ ТЕСТУВАННЯ\n\n";
            const reliabilityScore = scores['Достовірність'];
            fullText += `Шкала достовірності: ${reliabilityScore} балів.\n${interpretations['Достовірність'](reliabilityScore)}\n\n`;

            if (reliabilityScore >= 10) {
                 return {fullText};
            }

            for (const scaleKey in scores) {
                if (scaleKey === 'Достовірність') continue;

                const rawScore = scores[scaleKey];
                const match = scaleKey.match(/\(([А-ЯІЇЄ]+)\)/);
                const stenKey = match ? match[1] : null;

                const sten = getSten(stenKey, rawScore);
                let interpretationText = "";

                if (sten && interpretations[stenKey] && interpretations[stenKey][sten]) {
                    interpretationText = interpretations[stenKey][sten];
                }

                fullText += `--- ${scaleKey} ---\n`;
                fullText += `Сирий бал: ${rawScore}\n`;
                if(sten) {
                   fullText += `Стен: ${sten}\n`;
                   fullText += `Інтерпретація: ${interpretationText}\n\n`;
                } else {
                   fullText += `\n`;
                }
            }

            const oapRaw = (scores['Поведінкова регуляція (ПР)'] || 0) + (scores['Комунікативний потенціал (КП)'] || 0) + (scores['Моральна нормативність (МН)'] || 0);
            const oapResult = getOapResult(oapRaw);

            fullText += `=================================\n`;
            fullText += `ЗАГАЛЬНИЙ АДАПТАЦІЙНИЙ ПОТЕНЦІАЛ\n`;
            fullText += `=================================\n`;
            fullText += `ОАП (сума ПР, КП, МН): ${oapRaw}\n`;
            fullText += `Стен: ${oapResult.sten}\n`;
            fullText += `Рівень стійкості до бойового стресу: ${oapResult.level} (${oapResult.name})\n`;
            fullText += `Висновок: ${oapResult.interpretation}\n`;

            return {fullText};
        }

        function generateTelegramCaption(scores) {
            const pib = `${lastNameInput.value} ${firstNameInput.value} ${patronymicInput.value}`;
            let unitPath = getUnitPathForFileName(false);

            let caption = `Звіт "Адаптивність-200"\n\n`;
            caption += `Підрозділ: ${unitPath}\n`;
            caption += `Посада: ${selectionState.position}\n`;
            caption += `Звання: ${selectionState.rank}\n`;
            caption += `ПІБ: ${pib}\n`;
            caption += `Дата: ${new Date().toLocaleString('uk-UA')}`;

            return caption;
        }

        function generateTxtReport(scores, returnBlob = false) {
            const interpretationData = generateInterpretation(scores);
            let content = `ЗВІТ "АДАПТИВНІСТЬ-200"\n`;
            content += `=================================\n`;
            content += `${generateTelegramCaption(scores).replace(/\*/g, '')}\n`;
            content += `=================================\n\n`;
            content += interpretationData.fullText;

            return new Blob([content], { type: 'text/plain;charset=utf-8' });
        }

        async function generateXlsxReport(returnBlob = false) {
            const pib = `${lastNameInput.value} ${firstNameInput.value} ${patronymicInput.value}`;
            const unitPath = getUnitPathForFileName(false);

            const answersData = [];
            answersData.push([`Підрозділ: ${unitPath}`]);
            answersData.push([`Посада: ${selectionState.position}`]);
            answersData.push([`Звання: ${selectionState.rank}`]);
            answersData.push([`ПІБ: ${pib}`]);
            answersData.push([]);
            answersData.push(["ТАК", "НІ", "№", "Питання"]);

            userAnswers.forEach((answer, index) => {
                const row = [
                    answer === 'yes' ? 'V' : '',
                    answer === 'no' ? 'V' : '',
                    index + 1,
                    questions[index]
                ];
                answersData.push(row);
            });
            const wsAnswers = XLSX.utils.aoa_to_sheet(answersData);

            const cols = [ {wch:5}, {wch:5}, {wch:5}, {wch:100} ];
            wsAnswers['!cols'] = cols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsAnswers, "Відповіді");

            if (returnBlob) {
                 const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                 return new Blob([wbout], { type: 'application/octet-stream' });
            }
        }

        function getUnitPathForFileName(forFileName = false){
            let unitPath = '';
            const separator = forFileName ? '_' : ' ';
            if (selectionState.isCompany) {
                const unitMatch = selectionState.unit.match(/\d+/);
                const platoonMatch = selectionState.platoon.match(/\d+/);
                const squadMatch = selectionState.squad.match(/\d+/);
                unitPath = `${squadMatch ? squadMatch[0] : '0'}${separator}відділення${separator}охорони${separator}${platoonMatch ? platoonMatch[0] : '0'}${separator}взводу${separator}охорони${separator}${unitMatch ? unitMatch[0] : '0'}${separator}роти${separator}охорони${separator}6${separator}батальйону${separator}охорони`;
            } else {
                unitPath = selectionState.unit.replace(/ /g, separator) + `${separator}6${separator}батальйону${separator}охорони`;
            }

            if (!forFileName) {
               return unitPath.replace(/_/g, ' ');
            }
            return unitPath;
        }

        // Initial setup
        populateList(unitList, units, 'type', 'name');
        showSection('selection-section');
    };
    </script>
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
